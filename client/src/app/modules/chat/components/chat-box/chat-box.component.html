<div class="chat-section flex flex-col h-full">
  <div
    #messageScroll
    class="flex-1 custom-scroll overflow-y-auto p-4 flex flex-col gap-2"
    style="overscroll-behavior-y: contain"
  >
    <div
      class="message max-w-[85%] md:max-w-[70%]"
      *ngFor="let item of chatService.chatMessages(); let i = index"
      [ngClass]="{
        'self-end': item.senderId === authService.currentLoggedUser?.id,
        'self-start': item.senderId !== authService.currentLoggedUser?.id,
      }"
    >
      <div class="flex items-end gap-2">
        @if (item.senderId === authService.currentLoggedUser?.id) {
          <span class="text-gray-400 hover:text-primary mb-2 transition-colors">
            <mat-icon
              (click)="addReplyMessage(item)"
              class="cursor-pointer text-[20px] w-[20px] h-[20px]"
              >reply</mat-icon
            >
          </span>
        }

        <div
          class="pt-2 px-2 rounded-xl shadow-sm text-sm md:text-base relative min-w-[120px]"
          [ngClass]="{
            'bg-mint rounded-br-none text-slate-800':
              item.senderId === authService.currentLoggedUser?.id,
            'bg-gray-100 rounded-bl-none text-gray-800':
              item.senderId !== authService.currentLoggedUser?.id,
          }"
        >
          <div
            *ngIf="item.replyMessageContent"
            class="mb-2 p-1 rounded bg-black/5 border-l-4 text-xs flex flex-col cursor-pointer hover:bg-black/10 transition"
            [ngClass]="{
              'border-primary':
                item.senderId === authService.currentLoggedUser?.id,
              'border-gray-400':
                item.senderId !== authService.currentLoggedUser?.id,
            }"
          >
            <span class="font-bold text-primar">
              {{ item.replyMessageSenderName || "Користувач" }}
            </span>
            <span class="truncate opacity-80 italic line-clamp-1">
              {{ item.replyMessageContent }}
            </span>
          </div>
          @if (item.attachments && item.attachments.length > 0) {
            <div class="flex flex-col gap-2 mb-2">
              @for (att of item.attachments; track $index) {
                @if (att.type === "image") {
                  <div class="rounded-lg overflow-hidden border border-black/5">
                    <img
                      [src]="att.path"
                      class="w-full h-auto max-h-[300px] object-cover cursor-pointer hover:opacity-95 transition"
                      alt="attachment"
                      (click)="viewImage(att.path)"
                    />
                  </div>
                } @else if (att.type === "video") {
                  <div class="rounded-lg overflow-hidden bg-black">
                    <video
                      [src]="att.path"
                      controls
                      class="w-full max-h-[300px]"
                    ></video>
                  </div>
                } @else {
                  <a
                    [href]="att.path"
                    target="_blank"
                    class="flex items-center gap-3 p-2 rounded-lg bg-black/5 hover:bg-black/10 transition border border-black/5 no-underline group"
                  >
                    <div
                      class="w-8 h-8 rounded-full bg-white flex items-center justify-center shrink-0 text-primary"
                    >
                      <mat-icon
                        class="text-[20px] w-[20px] h-[20px] flex items-center justify-center"
                      >
                        {{
                          att.type === "pdf" ? "picture_as_pdf" : "description"
                        }}
                      </mat-icon>
                    </div>
                    <div class="flex flex-col min-w-0 overflow-hidden">
                      <span
                        class="text-xs font-semibold truncate w-full text-gray-800"
                        >{{ att.name }}</span
                      >
                      <span class="text-[10px] text-gray-500 uppercase"
                        >{{ att.name.split(".").pop() }} File</span
                      >
                    </div>
                    <mat-icon
                      class="ml-auto text-gray-400 group-hover:text-primary"
                      >download</mat-icon
                    >
                  </a>
                }
              }
            </div>
          }
          @if (item.content) {
            <span class="break-words block leading-relaxed">
              {{ item.content }}
            </span>
          }

          <div class="flex justify-between items-center gap-1">
            <span class="text-[10px] text-gray-500 opacity-70">
              {{ item.createdDate | date: "HH:mm" }}
            </span>
            @if (item.senderId === authService.currentLoggedUser?.id) {
              <span class="text-primary"
                ><mat-icon class="scale-70">{{
                  item.isRead ? "done_all" : "done"
                }}</mat-icon>
              </span>
            }
          </div>
        </div>
        @if (item.senderId !== authService.currentLoggedUser?.id) {
          <span class="text-gray-400 hover:text-primary mb-2 transition-colors">
            <mat-icon
              (click)="addReplyMessage(item)"
              class="cursor-pointer text-[20px] w-[20px] h-[20px]"
              >reply</mat-icon
            >
          </span>
        }
      </div>
    </div>
  </div>
</div>
